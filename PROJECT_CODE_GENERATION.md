# Auto-Generate Project Code for Opportunities

## Overview

This feature automatically generates a **Project Code** (`cf_859`) when a new Opportunity (Potentials) is created. The Project Code follows a specific format and cannot be manually edited by users.

## Business Rules

### 1. Project Name
- **User MUST be allowed** to enter Project Name during Opportunity creation
- This value will be used to generate Project Code
- Project Name remains **editable** after creation

### 2. Project Code
- **Must be auto-generated** - users cannot manually enter or edit
- Field is **read-only** in UI (both Create and Edit views)
- Format: `{CREATE_DATE}-{CONTACT_ID}-{COMPANY_CODE}-{PROJECT_NAME}`

### 3. Generation Format

**Format:** `{CREATE_DATE}-{CONTACT_ID}-{COMPANY_CODE}-{PROJECT_NAME}`

**Example:** `20260105-CON13-z751-che-la-ca`

**Components:**
- **CREATE_DATE:** `YYYYMMDD` format from Opportunity `createdtime`
- **CONTACT_ID:** Contact code (e.g., `CON13`) from `vtiger_contactdetails.contact_no`
- **COMPANY_CODE:** Company code from related Account (custom field `cf_855` or `account_no` as fallback)
- **PROJECT_NAME:** Project name from custom field `cf_857` or `potentialname` as fallback

## Implementation

### Files Created/Modified

1. **`modules/Potentials/ProjectCodeHandler.php`**
   - Event handler for `vtiger.entity.aftersave`
   - Generates Project Code only for **new records** (`isNew == true`)
   - Only generates if `cf_859` is **empty**
   - Prevents infinite save loop by checking conditions before update

2. **`modules/Install/models/InitSchema.php`**
   - Registers handler during fresh installation
   - Event: `vtiger.entity.aftersave`

3. **`layouts/v7/modules/Potentials/resources/Edit.js`**
   - Makes `cf_859` field read-only in Create/Edit views
   - Prevents user input, focus, typing, and paste
   - Applies visual styling (grey background, disabled cursor)

4. **`register_project_code_handler.php`**
   - Standalone script to register handler for existing installations
   - Can be run via browser or CLI

## Loop Prevention

The handler prevents infinite save loops through multiple safeguards:

1. **Event Selection:** Uses `vtiger.entity.aftersave` (not `aftersave.final`) to avoid recursion
2. **New Record Check:** Only processes when `$entityData->isNew() == true`
3. **Empty Check:** Only generates if `cf_859` is empty or NULL
4. **Silent Updates:** No output, no exceptions thrown, silent error handling
5. **Direct DB Update:** Updates `vtiger_potentialscf` directly without triggering save events

## Data Sources

### CREATE_DATE
- **Source:** `vtiger_crmentity.createdtime`
- **Format:** `YYYYMMDD` (e.g., `20260105`)

### CONTACT_ID
- **Source:** `vtiger_potential.contact_id` → `vtiger_contactdetails.contact_no`
- **Format:** Auto-generated by Vtiger (e.g., `CON13`, `CON14`)
- **Required:** Yes - handler exits if no contact linked

### COMPANY_CODE
- **Primary:** `vtiger_accountscf.cf_855` (custom field)
- **Fallback:** `vtiger_account.account_no` if `cf_855` is empty
- **Source:** Related Account via `vtiger_potential.related_to`
- **Required:** Yes - handler exits if no account linked

### PROJECT_NAME
- **Primary:** `vtiger_potentialscf.cf_857` (custom field for Project Name)
- **Fallback:** `vtiger_potential.potentialname` if `cf_857` is empty
- **Required:** Yes - handler exits if empty

## Installation

### For Fresh Installations
Handler is automatically registered via `InitSchema.php` during installation.

### For Existing Installations

**Option 1: Run PHP Script**
```bash
php register_project_code_handler.php
```

**Option 2: Manual Database Registration**
```sql
INSERT INTO vtiger_eventhandlers 
(event_name, handler_path, handler_class, is_active, dependent_on, priority)
VALUES 
('vtiger.entity.aftersave', 'modules/Potentials/ProjectCodeHandler.php', 'ProjectCodeHandler', 1, '', 0);
```

## Testing

### Test Case 1: Create New Opportunity with All Fields
1. Create a new Contact (note `contact_no`, e.g., `CON13`)
2. Create a new Account with Company Code (`cf_855` = `z751`)
3. Create a new Opportunity:
   - Link Contact
   - Link Account
   - Enter Project Name (`cf_857` = `che-la-ca`)
4. Save Opportunity
5. **Expected:** `cf_859` = `20260105-CON13-z751-che-la-ca` (date may vary)

### Test Case 2: Create Opportunity Without Contact
1. Create Opportunity without linking Contact
2. Save
3. **Expected:** `cf_859` = `NULL` (no code generated)

### Test Case 3: Edit Existing Opportunity
1. Edit an existing Opportunity
2. Change Project Name
3. Save
4. **Expected:** `cf_859` remains unchanged (no regeneration)

### Test Case 4: Verify Read-Only Field
1. Open Opportunity Create/Edit view
2. Try to type in `cf_859` field
3. **Expected:** Field is disabled, cannot type, grey background

## Verification Queries

### Check Generated Project Codes
```sql
SELECT 
    p.potentialid,
    p.potentialname,
    p.contact_id,
    cd.contact_no,
    a.accountname,
    acf.cf_855 as company_code,
    pcf.cf_857 as project_name,
    pcf.cf_859 as project_code,
    ce.createdtime
FROM vtiger_potential p
LEFT JOIN vtiger_contactdetails cd ON cd.contactid = p.contact_id
LEFT JOIN vtiger_account a ON a.accountid = p.related_to
LEFT JOIN vtiger_accountscf acf ON acf.accountid = p.related_to
LEFT JOIN vtiger_potentialscf pcf ON pcf.potentialid = p.potentialid
LEFT JOIN vtiger_crmentity ce ON ce.crmid = p.potentialid
ORDER BY p.potentialid DESC
LIMIT 10;
```

### Find Opportunities Without Project Code
```sql
SELECT 
    p.potentialid,
    p.potentialname,
    p.contact_id,
    p.related_to
FROM vtiger_potential p
LEFT JOIN vtiger_potentialscf pcf ON pcf.potentialid = p.potentialid
WHERE (pcf.cf_859 IS NULL OR pcf.cf_859 = '')
AND p.contact_id IS NOT NULL
AND p.contact_id != 0
AND p.related_to IS NOT NULL
AND p.related_to != 0;
```

## Troubleshooting

### Project Code Not Generated

1. **Check Handler Registration:**
   ```sql
   SELECT * FROM vtiger_eventhandlers 
   WHERE handler_class = 'ProjectCodeHandler';
   ```

2. **Check Handler is Active:**
   ```sql
   SELECT is_active FROM vtiger_eventhandlers 
   WHERE handler_class = 'ProjectCodeHandler';
   ```
   Should return `1`.

3. **Check Required Fields:**
   - Contact must be linked (`contact_id` not NULL)
   - Account must be linked (`related_to` not NULL)
   - Project Name must be entered (`cf_857` or `potentialname`)

4. **Check Logs:**
   - Review `logs/vtigercrm.log` for `[ProjectCodeHandler]` entries
   - Look for error messages or debug logs

### Field Not Read-Only

1. **Clear Browser Cache**
2. **Check JavaScript Console** for errors
3. **Verify Edit.js is loaded:**
   - Check Network tab in browser DevTools
   - Look for `layouts/v7/modules/Potentials/resources/Edit.js`

## Safety Requirements

✅ **Prevent Infinite Save Loop:** Multiple checks prevent recursion  
✅ **No White Screen:** Silent error handling, no output  
✅ **No JS Save Override:** Uses standard Vtiger event system  
✅ **Works for Create/Quick Create/API:** Handler works for all save methods  

## Output Confirmation

After successful implementation:
- ✅ Project Code appears in Detail View
- ✅ Project Code is read-only in Edit View
- ✅ Project Code format matches: `YYYYMMDD-CON##-COMPANY-PROJECTNAME`
- ✅ No errors in logs
- ✅ No blank pages on save

